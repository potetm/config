#!/usr/bin/env bash

typeset -r REGION="$1"
typeset -r INSTANCE_NAME="$2"

if [[ -z $REGION || -z $INSTANCE_NAME ]]; then
  echo "usage: start-aws-instance <region> <instance-name>" >&2
  exit 1
fi

typeset describe="$(aws ec2 describe-instances --region "$REGION" --filters "Name=tag:Name,Values=$INSTANCE_NAME")"

if [[ $(echo "$describe" | jq -r '.Reservations | length == 0') == true ]]; then
  echo "there are no instances with that name in this region" >&2
  exit 1
fi

typeset envGroup=$(echo "$describe" | jq -r '.Reservations[0].Instances[0].Tags | map(select(.Key == "EnvGroup"))[0].Value')

if [[ $envGroup == @(prod|eu) ]]; then
  echo "Ask yourself if you are doing the right thing here. This *is* production." >&2
  exit 1
fi

typeset instanceId=$(echo "$describe" | jq -r '.Reservations[0].Instances[0].InstanceId')

if [[ -z $instanceId ]]; then
  echo "could not find instance" >&2
  exit 1
fi

aws ec2 start-instances --region "$REGION" --instance-ids "$instanceId"
