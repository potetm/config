#!/usr/bin/env bash

typeset describe="$(aws ec2 describe-instances --region eu-west-1 --filters "Name=tag:EnvGroup,Values=dr-eu")"

if [[ $(echo "$describe" | jq -r '.Reservations | length == 0') == true ]]; then
  echo "there are no instances with that name in this region" >&2
  exit 1
fi

typeset instanceIds=$(echo "$describe" | jq -r '
  .Reservations |
  map(.Instances[0]) |
  map(select(.Tags |
             map(.Key == "Name" and
                (.Value == "dr-eu-bastion" or
                 .Value == "dr-eu-nfs" or
                 .Value == "dr-eu-nat")) |
             any |
             not)) |
  map(.InstanceId) |
  join(" ")')

if [[ -z $instanceIds ]]; then
  echo "could not find instances" >&2
  exit 1
fi

aws ec2 stop-instances --region eu-west-1 --instance-ids $instanceIds
