#!/usr/bin/env bash

# This script assumes that there is only one session running

# Note that the window name needs to be what is on the left-hand-side
typeset -rA SPECIAL_KILL_COMMANDS=(
  ["rabbitmq"]="rabbitmqctl stop"
)

typeset -r SESSION_NAME="$(tmux list-sessions | cut -d: -f1)"
typeset -a WINDOWS=()

while read win; do
  WINDOWS+=( "$win" )
done < <(tmux list-windows -t "$SESSION_NAME" | sed -r 's/^[0-9]:\s+([^(*-]+)+[*-]?\s+\(.*$/\1/')

echo ${WINDOWS[@]}
for window in "${WINDOWS[@]}"; do
  if [[ ${SPECIAL_KILL_COMMANDS[$window]+_} ]]; then
    ${SPECIAL_KILL_COMMANDS[$window]}
  else
    tmux send-keys -t "$SESSION_NAME":"$window" 'C-c'
  fi
done

# cleanup

# Rabbit won't clean this up for fear of messing up other erlang processes.
if pgrep -q epmd; then
  pkill epmd
fi

# For some reason lein leaves cljsbuild running when you C-c it.
if pgrep -qf analytics-engine; then
  pkill -9 -f analytics-engine
fi

tmux kill-session -t "$SESSION_NAME"
